{% load static %}

<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <!-- this is where the static files are served locally. for procudtion, we should use the CDN version -->
    <!-- <link href='{% static "css/bootstrap.min.css" %}' rel='stylesheet'> -->
    <!-- CDN Version of Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- CDN for FontAwesome, which is where our little glyphicons come from -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.10/js/all.js" integrity="sha384-slN8GvtUJGnv6ca26v8EzVaR9DC58QEwsIk9q1QXdCU8Yu8ck/tL/5szYlBbqmS+" crossorigin="anonymous"></script>

    <!-- additional css for changing colors -->
    <!-- build set of global variables n static -->
    <style>
      .apogee-btn {
        color: black;
        background-color: orchid;
      }
      .grey-color {
        color: #ccc;
      }
      .red-color {
        color: red;
      }
      .yellow-color {
        content: "\f005";
        color: #e4c43a;
      }
      .media-focus {
        background-color: #8080803b;
      }
      /*this allows form errors to show*/
      .invalid-feedback {
        display: block;
      }
      .grey-background {
        background-color: #f1f1f1;
      }
    </style>

    <!-- block title allows us to push a new title from each page -->
    <!-- you can access the apogee text by calling block.super -->
    <title>{% block title %}Apogee{% endblock title %}</title>
  </head>
  <body>
    <!-- navbar goes outside container bc the container has margins. 
    moving it out allows it to stretch the whole way across -->
    {% include 'navbar.html' %}
    <!-- this holds the actual content from each individual page -->
    <!-- the container has margins, eliminate them with container fluid -->
    <div class='container-fluid'>
        {% block content %}
        {% endblock content %}
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- Botstrap comes with slim version of jQuery, but we've updated to full version so that we can use AJAX stuff -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <!-- Local version of Bootstrap JS, switch to CDN version for production -->
    <!-- <script src='{% static "js/bootstrap.min.js" %}'></script> -->
    <!-- CDN version of Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <!-- this contains all of the js used to parties. it's here so that we can use the same rendering in every view that needs it -->
    <script>
      // JS search function from stack overflow at kirr.co/itd0rd
      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        let regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }


      function loadPartyContainer(partyContainerID, fetchOneId) {
        // this grabs the search terms from the search bar
        let query = getParameterByName('q');
        // this is the set of events in the api
        let partyList = [];
        // this links to the following page in the api
        let nextPartyUrl;
        // this is the selector for where we're putting the party info
        // 
        let partyContainer;
        if (partyContainerID){
          partyContainer = $('#' + partyContainerID)
        } else {
          partyContainer = $('#party-container')
        }
        // starting url that allows us to get the api data. second is  default
        let initialUrl = partyContainer.attr('data-url') || '/api/events/';

        // this needs to be built into a responsive variable so that we can 
        // always have the correct number of events on each line
        let handSize;

        // these are repeated calls, so they've been converted to variables
        let click = 'click';
        let star_active = '<i class="fa fa-star yellow-color" aria-hidden="true"></i>';
        let star_inactive = '<i class="fa fa-star grey-color" aria-hidden="true"></i>';
        let free = 'FREE';
        let join = 'Enter';
        let joined = 'Joined';
        let drawing_icon = '<i class="fas fa-ticket-alt grey-color" data-toggle="tooltip" data-placement="top" title="Drawing"></i>';
        let bid_icon = '<i class="fas fa-gavel grey-color" data-toggle="tooltip" data-placement="top" title="Auction"></i>';
        let buy_icon = '<i class="fa fa-donate grey-color" data-toggle="tooltip" data-placement="top" title="Buy Now"></i>';
        let closed_icon = '<i class="fas fa-ban grey-color"></i>';


        // this is the favorite function. It wil be instrumental in enabling 
        // users to track events as they progress.
        $(document.body).on(click, '.starBtn', function(e){
          e.preventDefault()
          // make sure these variables are let, not var. var is global,  so it doesnt 
          // handle scope properly
          let this_ = $(this)
          // selector for the button
          let partyID = this_.attr('data-id')
          // api endpoint
          let starredUrl = '/api/events/' + partyID + '/star/'
          $.ajax({
            method: 'GET',
            url: starredUrl,
            success: function(data){
              // the api handles updating the database and the method below
              // updates the color, so nothing happens on success
            }, 
            error: function(data){
              console.log('error')
              console.log(data)
            }
          })
        })


        // this controls the display color of the favorite button
        $(document.body).on(click, '.fa-star', function(e){
          e.preventDefault()
          let this_ = $(this)
          this_.toggleClass('grey-color')
          this_.toggleClass('yellow-color')
        })


        // this is the join function
        $(document.body).on(click, '.joinBtn', function(e){
          e.preventDefault()
          let this_ = $(this)
          // selector for the button
          let partyID = this_.attr('data-id')
          // api endpoint
          let joinedUrl = '/api/events/' + partyID + '/join/'
          $.ajax({
            method: 'GET',
            url: joinedUrl,
            // dont need the success error block is they arent doing anything
            success: function(data){
              // the api handles updating the database 
            }, 
            error: function(data){
              console.log('error')
              console.log(data)
            }
          })
        })


        // this controls the display of the join button
        // anytime it is clicked, it should say joined, so it doesnt check anything
        $(document.body).on(click, '.joinDisplay', function(e){
          e.preventDefault()
          let this_ = $(this)
          let text = this_.text()
          this_.addClass('disabled')
          this_.text(joined)
        })

        // this allows search along hashtags. 
        // could be useful for categorization
        function updateHashLinks(){
          // this is where the actual title and description are held
          // the span allows up to properly id the hashtags in the description
          // it will not highlight anf link a hashtag in the title
          $('.description').each(function(data){
            let hashtagRegex = /(^|\s)#([\w\d-]+)/g // pulls hashtags
            let usernameRegex = /(^|\s)@([\w\d-]+)/g // pulls user mentions
            let currentHtml = $(this).html()
            let newText;
            // the regex returns stuff before and after
            // the replace puts the before in and then makes a link for the after
            newText = currentHtml.replace(hashtagRegex, '$1<a class="text-dark" href="/tags/$2/">#$2</a>')
            newText = newText.replace(usernameRegex, '$1<a class="text-dark" href="/profiles/$2/">@$2</a>')
            $(this).html(newText)
          })
        }


        function formatParty(partyValue){
          let verb = star_inactive
          if (partyValue.did_star){
            verb = star_active
          }

          let price = '$' + partyValue.cost
          if (partyValue.cost == 0) {
            price = free
          }

          let type_icon = ''
          if (partyValue.event_type == 1) {
            type_icon = drawing_icon
          } else if (partyValue.event_type == 2) {
            type_icon = bid_icon
          } else if (partyValue.event_type == 3) {
            type_icon = buy_icon
          }

          // adds small closed icon if event is closed. the tooltip explains the icon
          let closed_display = ''
          if (!partyValue.is_open) {
            closed_display = '<span class="float-right" data-toggle="tooltip" data-placement="top" title="Event Closed">' + closed_icon + '</span>'
          }

          // redo string formatting
          let container =  
          '<div class="card" style="max-width: 16rem;">' + 
            '<a class="text-dark" href="/events/' + partyValue.id + '" style="text-decoration: none;">' +
              '<img class="card-img-top" src="' + partyValue.thumbnail_url + '" alt="not here">' + 
            '</a>' +
            '<div class="card-body">' + 
              '<a class="text-dark" href="/events/' + partyValue.id + '" style="text-decoration: none;">' +
                '<h5 class="card-title">' + partyValue.title + closed_display + '</h5>' + 
                '<p class="card-text"><span class="description">' + partyValue.short_description + '</span></p>' + 
              '</a>' +
            '</div>' + 
            '<div class="card-footer">' + 
              '<small class="text-muted">With ' + 
                '<a class="text-dark" href="' + partyValue.user.url + '">'+ partyValue.user.username + '</a>' + 
                '<span class="float-right">' + price + ' ' + type_icon + '</span>' +
                '<br>' + partyValue.party_time_display + 
              '</small>' + 
              '<span class="float-right">' + 
                '<a href="#" class="starBtn text-dark" data-id="' + partyValue.id + '">' + verb + '</a>' + 
              '</span>' + 
            '</div>' + 
          '</div>'
          // just return it immediately
          return container
        }


        function formatSingle(partyValue){
          let star_verb = star_inactive
          if (partyValue.did_star){
            star_verb = star_active
          }

          // selects icon next to price
          let type_icon = ''
          if (partyValue.event_type == 1) {
            type_icon = drawing_icon
          } else if (partyValue.event_type == 2) {
            type_icon = bid_icon
          } else if (partyValue.event_type == 3) {
            type_icon = buy_icon
          }

          // this picks the text for the join button to show event type
          if (partyValue.event_type == 1) {
            join = "Enter Drawing"
          } else if (partyValue.event_type == 2) {
            join = "Submit a Bid"
          } else if (partyValue.event_type == 3) {
            join = "Buy Event"
          }

          // this sets the display of the button itself
          let join_verb = ''
          if (!partyValue.is_owner){
              join_verb = '<button type="button" class="btn btn-outline-secondary btn-block m-3 joinBtn joinDisplay" data-id="' + partyValue.id + '">' + join + '</button>'
            if (partyValue.did_join) {
              join_verb = '<button type="button" class="btn btn-outline-secondary btn-block m-3 joinBtn joinDisplay disabled" data-id="' + partyValue.id + '">' + joined + '</button>'
            }
          } 
          // replaces the join button with a closed message if the event is over
          if (!partyValue.is_open) {
            join_verb = '<p class="mx-auto lead text-center text-muted">This Event Has Ended</p>'
          }


          let winner = ''
          if (partyValue.winner_names.length > 0) {
            winner = '<div class="row mt-3"><h1 class="mx-auto"> ' + partyValue.winner_names + ' is the winner!</h1></div>'
          }

          let price = '$' + partyValue.cost
          if (partyValue.cost == 0) {
            price = free
          }

          let container =
          '<div class="row mt-3">' +
            '<div class="col-sm-4">' +  
              '<img class="img-fluid rounded mx-auto" src="' + partyValue.thumbnail_url + '" alt="not here">' + 
            '</div>' +
            '<div class="col-sm-8">' +
              '<h1>' + partyValue.title + 
                '<span class="float-right">' + 
                  '<a href="#" class="starBtn text-dark" data-id="' + partyValue.id + '">' + star_verb + '</a>' + 
                '</span>' + 
              '</h1>' +
              '<small class="text-muted">With ' + 
                '<a class="text-dark" href="' + partyValue.user.url + '">'+ partyValue.user.username + '</a> On ' + partyValue.party_time_display + 
              '</small><br>' + 
              '<p class="lead mt-4">' + partyValue.description + '</p>' + 
            '</div>' +
          '</div>' +
          '<div class="row mt-3">' + 
            '<div class="col-sm-12">' + 
              '<p class="text-muted">' + price + ' ' + type_icon + '</p>' +
            '</div>' +
            '<div class="col-sm-12">' + 
              '<p class="text-muted">' + partyValue.joins + ' <small class="text-muted">Joined</small></p>' +
            '</div>' +
          '</div>' +
          '<div class="row">' + join_verb + '</div>' + winner 

          return container
        }


        // reworked version of the parseParties call
        // this creates sets of deck elements and populates them with the proper
        // number of cards. handSize sets the number of cards per deck. this 
        // allows the page to be more responsive and change the number of cards 
        // per deck given the width of the page. 
        function parseParties(){
          if (partyList == 0) {
            partyContainer.text('No events :(')
          } else {
            // make global variable, make responsive
            handSize = 3
            for (let deck = 0; deck < partyList.length; deck += handSize) {
              let deckHTML = '<div class="card-deck mb-4">'
              for (let card = 0; card < handSize; card++) {
                let cardIndex = deck + card
                if (cardIndex < partyList.length) {
                  let partyValue = partyList[cardIndex]
                  let partyFormattedHtml = formatParty(partyValue)
                  deckHTML = deckHTML + partyFormattedHtml
                }
              }
              deckHTML = deckHTML + '</div>'
              partyContainer.append(deckHTML)
            }
          }
        }


        // The detail view version of parseparties
        function parseSingle(){
          let partyValue = partyList[0]
          let partyFormattedHtml = formatSingle(partyValue)
          partyContainer.append(partyFormattedHtml) 
        }


        // this is the initial call to the api, which might include search terms
        function fetchParties(url){
          let fetchUrl;

          // if there isnt a url passed, its the first api page
          if (!url) {
            fetchUrl = initialUrl
          } else {
            fetchUrl = url
          }
          // actual call to api
          $.ajax({
            url: fetchUrl, 
            data: {
              'q': query
            },
            method: 'GET', 
            success: function(data){
              // the .results is required because of our pagination
              // it sets a new datagrouping outside of the data we're using
              partyList = data.results

              if (data.next) {
                nextPartyUrl = data.next
              } else {
                $('#loadmore').css('display', 'none')
              }
              parseParties()
              updateHashLinks()
            }, 
            error: function(data){
              console.log('error')
              console.log(data)
            }
          })
        }

        // for single view
        function fetchSingle(fetchOneId){
          // leading slash appends it to the base url. 
          // no leading slash sends it to the url of the page its on
          // which would be /events/id/api/events/id 
          let fetchDetailUrl = '/api/events/' + fetchOneId + '/'
          // actual call to api
          $.ajax({
            url: fetchDetailUrl, 
            method: 'GET', 
            success: function(data){
              console.log(data)
              partyList = data.results
              parseSingle()
              updateHashLinks()
            }, 
            error: function(data){
              console.log('error')
              console.log(data)
            }
          })
        }


        // for the single detail view
        if (fetchOneId){
          fetchSingle(fetchOneId)
        } else {
          fetchParties()
        }

        // if (nextPartyUrl) {
        //   fetchParties(nextPartyUrl)
        // }


        // this handles our loadmore button
        // it binds a function to the clicking action
        $('#loadmore').click(function(event){
          event.preventDefault()

          // assuming there are more events, get and show them
          if (nextPartyUrl) {
            fetchParties(nextPartyUrl)
          }
        })
      }
    </script>



    <!-- this is our custom JS block where we'll put our ajax stuff -->
    {% block script %}
    {% endblock script %}

    <!-- this is the keyup auto search function -->
    <!-- <script>
      $(document).ready(function(){
        var typingTimer;
        var doneInterval = 1000; // milliseconds
        var searchInput = $('#navbar-search-form input[type=text]')
        var searchQuery;

        searchInput.keyup(function(event){
          searchQuery = $(this).val() // grabs search terms

          // resets timer then sets new timer and function
          clearTimeout(typingTimer) 
          typingTimer = setTimeout(doneSearchTyping, doneInterval)
        })

        searchInput.keydown(function(event){
          // when you start typing, it clears the timer
          clearTimeout(typingTimer)
        })

        // submits the search
        function doneSearchTyping(){
          if (searchQuery){
            var url = '/search/?q=' + searchQuery
            document.location.href = url;
          }
        }
      })
    </script> -->

  </body>
</html>










